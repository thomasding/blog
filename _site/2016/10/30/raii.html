<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RAII</title>
  <meta name="description" content="RAII is a very important technique in C++, although its full name is a little obscure: Resource Acquisition Is Initialization. While RAII can be briefly desc...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://tding.in/2016/10/30/raii.html">
  <link rel="alternate" type="application/rss+xml" title="tding.in" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">tding.in</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/archive/">Archive</a>
          
        
          
          <a class="page-link" href="/tags/">Tags</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">RAII</h1>
    <div class="post-meta">
      <time datetime="2016-10-30T00:00:00+08:00" itemprop="datePublished">Oct 30, 2016</time>
      <ul class="post-tags post-meta">
        
        <li>
          <a href="/tags/#c++" class="post-tag">c++</a>
        </li>
        
      </ul>
    </div>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>RAII is a very important technique in C++, although its full name is a little
obscure: Resource Acquisition Is Initialization. While RAII can be briefly
described as: <strong>Bind a resource to an object, acquiring it in the constructor,
releasing it in the destructor, so that its life cycle is bound to that of the
object.</strong></p>

<p>To write a good RAII class, the following implementations should be <strong>avoided</strong>:</p>

<ol>
  <li>
    <p>to manually acquire or release the resource like open()/close()
method;</p>
  </li>
  <li>
    <p>to transfer the ownership of the resource by manual methods like move() or
transfer(), rather than move constructor or move assignment.</p>
  </li>
</ol>

<p>By conforming to RAII, many situations that introduces resource leaks can be
easily reduced, and at the same time, with clearer code.</p>

<!--more-->

<p>Prior to C++11, it is the programmer’s responsibility to remember to release the
resources in consideration of all the incidents that may occur, such as
exceptions and runtime errors. As the complexity of program grows, it is harder
for the programmer to properly release all the resources, at the same time
the code becoming more tangled.</p>

<p>However, C++ compiler guarantees all the local object be destroyed when exiting the
current scope, no matter what happens. All that we need to do is to manage the
resource with a RAII class, and after that, it’s the compiler’s responsibility
to release them. Not only is the implementation more robust, but usually more
readable and shorter.</p>

<h1 id="bad-designs">Bad designs</h1>

<p>Assume that you’ve written a class to wrap the UNIX socket. Here is a bad
design (all the details about implementation have been omitted for brevity).</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Socket</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">// Empty constructors and destructors.
</span>    <span class="n">Socket</span><span class="p">()</span> <span class="p">{}</span>
    <span class="o">~</span><span class="n">Socket</span><span class="p">()</span> <span class="p">{}</span>
    <span class="c1">// We forbid the Socket object from being copied or moved,
</span>    <span class="c1">// for it's usually hard to copy or move resources correctly.
</span>    <span class="n">Socket</span><span class="p">(</span><span class="k">const</span> <span class="n">Socket</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Socket</span><span class="p">(</span><span class="n">Socket</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Socket</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">Socket</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Socket</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Socket</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>

    <span class="c1">// Connect to a given address. May throw bad_connection exception.
</span>    <span class="kt">void</span> <span class="n">connect</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dst</span><span class="p">);</span>
    <span class="c1">// Close the connection.
</span>    <span class="kt">void</span> <span class="n">close</span><span class="p">();</span>

    <span class="c1">// Read/write operations. May throw bad_connection exception.
</span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">read</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">use_socket</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Socket</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"10.101.30.2:1002"</span><span class="p">);</span>
    <span class="c1">// Do some I/O operations.
</span>    <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The deadliest problem above is that an exception may be thrown when doing I/O
operations. On that condition, the socket will not be closed, resulting in
resource leaks. By wrapping the I/O operations with a try-catch block, it is
guaranteed that the socket will always be closed.</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">use_socket</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Socket</span> <span class="n">s</span><span class="p">;</span>
    <span class="c1">// connect may fail. If connect fails, the exception is thrown to the
</span>    <span class="c1">// caller of the function.
</span>    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"10.101.30.2:1002"</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// Do some I/O operations.
</span>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(...)</span> <span class="p">{</span>
        <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="c1">// Throw the exception to the upper level of the function.
</span>        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now, assume that we need to open two sockets. The code becomes:</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">use_socket</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Socket</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">;</span>
    <span class="n">s1</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"10.101.30.2:1002"</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">s2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"10.101.30.3:1004"</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Do some I/O operations.
</span>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(...)</span> <span class="p">{</span>
            <span class="n">s2</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
            <span class="k">throw</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">s2</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(...)</span> <span class="p">{</span>
        <span class="n">s1</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">s1</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>With nested try-catch blocks, the function immediately becomes a little
unreadable, although we do nothing but open two sockets.</p>

<h1 id="good-design-with-raii">Good design with RAII</h1>

<p>Now we redesign the Socket class with RAII technique.</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Socket</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">// Connect to a given address. May throw bad_connection exception.
</span>    <span class="n">Socket</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dst</span><span class="p">);</span>
    <span class="c1">// Close the connection.
</span>    <span class="o">~</span><span class="n">Socket</span><span class="p">();</span>

    <span class="c1">// We forbid the Socket object from being copied or moved.
</span>    <span class="n">Socket</span><span class="p">(</span><span class="k">const</span> <span class="n">Socket</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Socket</span><span class="p">(</span><span class="n">Socket</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Socket</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">Socket</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Socket</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Socket</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>

    <span class="c1">// Read/write operations. May throw bad_connection exception.
</span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">read</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>By simply establishing the connection in constructor and closing in destructor,
the Socket class is much easier to use.</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">use_socket</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Socket</span> <span class="n">s1</span><span class="p">(</span><span class="s">"10.101.30.2:1002"</span><span class="p">);</span>
    <span class="n">Socket</span> <span class="n">s2</span><span class="p">(</span><span class="s">"10.101.30.3:1004"</span><span class="p">);</span>
    <span class="c1">// Do some I/O operations.
</span><span class="p">}</span>
</code></pre>
</div>

<p>In comparison to the try-catch style above, the RAII style is shorter, clearer,
safer, easier and overall better. You can simply open three sockets in the same
function without consideration of manually closing any of them.</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">use_socket</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Socket</span> <span class="n">s1</span><span class="p">(</span><span class="s">"10.101.30.2:1002"</span><span class="p">);</span>
    <span class="c1">// Do something first. May throw.
</span>    <span class="n">Socket</span> <span class="n">s2</span><span class="p">(</span><span class="s">"10.101.30.3:1004"</span><span class="p">);</span>
    <span class="c1">// Do something next. May throw.
</span>    <span class="n">Socket</span> <span class="n">s3</span><span class="p">(</span><span class="s">"10.101.30.4:1005"</span><span class="p">);</span>
    <span class="c1">// Do something then. May throw, too.
</span><span class="p">}</span>
</code></pre>
</div>

<p>You can transfer the socket out of the function by wrapping it in a unique_ptr.</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">make_http_connection</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">host</span><span class="p">,</span> 
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// auto keyword can be used to replace the long type name.
</span>    <span class="k">auto</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Socket</span><span class="p">(</span><span class="n">host</span><span class="p">));</span>
    <span class="c1">// Send HTTP request.
</span>    <span class="k">return</span> <span class="n">connection</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>When the unique_ptr object is destroyed and the socket has not been moved to
another unique_ptr object, the socket will be closed. Therefore, you can simply
forget about when to close it.</p>

  </div>

  
    

  
</article>




      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">tding.in <small><a href="/feed.xml">via RSS</a></small></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
          
            Thomas Ding
          
          </li>
          
          <li><a href="mailto:thomasbyding@gmail.com">thomasbyding@gmail.com</a></li>
          
          
          <li>
            <a href="https://github.com/thomasding"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">thomasding</span></a>

          </li>
          
          
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <p>Covering instruction-level optimization, C++ features, best practices and so many other interesting topics.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
